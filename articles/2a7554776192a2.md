---
title: "About Rust Rocket v0.5 and async"
emoji: "ğŸ…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
[Retail AI Adventurers Advent Calendar 2023](https://qiita.com/advent-calendar/2023/rai-adventurers) ã®æŠ•ç¨¿ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€æœ¬æ¥­ï¼ˆSREï¼‰ã®ã‹ãŸã‚ã‚‰ã§å–ã‚Šçµ„ã‚€ Backend Tech Stack ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€ã€ŒRust Rocket ã¨ Async ã«ã¤ã„ã¦ã€ã§ã™ã€‚

![image](image-1.png)

## tl;dr
* Rocket `v0.5`[^2] ãŒ 2023å¹´11æœˆã«  stable ã«ãªã‚Šã¾ã—ãŸã€‚
* Async ãŒ `v0.5` ã§è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
* Rocket ã¯ã€å…¥é–€è€…ã‚„ä¸­è¦æ¨¡å‘ã‘ã§ã™ã€‚

https://rocket.rs/v0.5/news/2023-11-17-version-0.5/

ã•ã‚‰ã«è©³ã—ãè¦‹ãŸã„æ–¹ã¯èª­ã¿ç¶šã‘ã¦ãã ã•ã„ã€‚

## About Rust Rocket
Rust Rocket[^2] ã¯ã€Rust ã® Web Framework ã® 1 ã¤ã§ã™ã€‚

https://rocket.rs/

Rust ã® Web Framework ã«ã¯ã€ä»–ã«ã‚‚ Axum[^1] ãªã©è¤‡æ•°ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚

:::details Axum ã¨ Rocket ã«é–¢ã™ã‚‹ GPT-4 ã®è§£èª¬
> Rustã§ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹Axumã¨Rocketã«ã¤ã„ã¦ã€ãã‚Œãã‚Œã®é•ã„ã‚’èª¬æ˜ã—ã¾ã™ã€‚
> 1. Axum
>    * é–‹ç™ºå…ƒ: Axumã¯Tokioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚
>    * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: Axumã¯éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ä¸­å¿ƒã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€Tokioã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨æ·±ãçµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šé«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨åŠ¹ç‡ãŒæœŸå¾…ã§ãã¾ã™ã€‚
>    * ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: Axumã§ã¯ã€é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã®å¼·åŠ›ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã§èª­ã¿ã‚„ã™ã„APIè¨­è¨ˆã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
>    * æŸ”è»Ÿæ€§: Axumã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ã¨æ‹¡å¼µæ€§ã«å„ªã‚Œã¦ãŠã‚Šã€ã•ã¾ã–ã¾ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
>    * ä½¿ç”¨ã‚±ãƒ¼ã‚¹: é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‹ã¤æ‹¡å¼µæ€§ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«é©ã—ã¦ã„ã¾ã™ã€‚
> 1. Rocket
>    * é–‹ç™ºå…ƒ: Rocketã¯ç‹¬ç«‹ã—ãŸã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
>    * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: Rocketã¯ã€å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè¨­è¨ˆã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯Rustã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ©ç”¨ã—ã¦ã€å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
>    * ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: Rocketã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã€å±æ€§ãƒ™ãƒ¼ã‚¹ã§ç›´æ„Ÿçš„ã«è¨˜è¿°ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚
>    * ç°¡æ½”æ€§ã¨ç”Ÿç”£æ€§: Rocketã¯ã€å¤šãã®æ©Ÿèƒ½ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ãŠã‚Šã€é–‹ç™ºè€…ãŒç´ æ—©ãåŠ¹ç‡çš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
>    * ä½¿ç”¨ã‚±ãƒ¼ã‚¹: ç‰¹ã«å…¥é–€è€…ã‚„ä¸­è¦æ¨¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©ã—ã¦ãŠã‚Šã€Rustã®å‹å®‰å…¨æ€§ã‚’æ´»ç”¨ã—ãŸé–‹ç™ºã‚’è¡Œã„ãŸã„å ´åˆã«é©ã—ã¦ã„ã¾ã™ã€‚
> * ç·æ‹¬
>    * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ‹¡å¼µæ€§: Axumã¯éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨Tokioã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ·±ã„çµ±åˆã«ã‚ˆã‚Šã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ‹¡å¼µæ€§ã‚’æä¾›ã—ã¾ã™ã€‚
>    * å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•: Rocketã¯ã€Rustã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æœ€å¤§é™ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•ã‚’é‡è¦–ã—ãŸè¨­è¨ˆã§ã™ã€‚
>    * é©ç”¨ç¯„å›²: Axumã¯å¤§è¦æ¨¡ã‹ã¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€Rocketã¯å…¥é–€è€…ã‚„ä¸­è¦æ¨¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é©ã—ã¦ã„ã¾ã™ã€‚
> 
> ã©ã¡ã‚‰ã‚’é¸ã¶ã‹ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã‚„å€‹äººã®å¥½ã¿ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
:::

* Axum: 
å¤§è¦æ¨¡ã‹ã¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚‚ã®å‘ã‘ã€‚
* Rocket: 
å…¥é–€è€…ã‚„ä¸­è¦æ¨¡å‘ã‘ã€‚

## Implementation
ãã‚Œã§ã¯å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ä»Šå›å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã¯ã€`users` ã¨ã„ã† table ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ REST API ã§ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã®æ–¹æ³•
- Axum:
resource ã‚’ `layer` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚Connection Pool ãªã©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãŸã‚‚ã®ã®å—ã‘æ¸¡ã—ã«ä½¿ãˆã¾ã™ã€‚

```rust: main.rs
#[tokio::main]
async fn main() {
    // çœç•¥
    
    let app = Router::new()
        .route("/users", get(user_handler).layer(Extension(user_service)))
    let addr = SocketAddr::new(IpAddr::V4(Ipv4Addr::new(127, 0, 0, 1)), 8080);
    axum::Server::bind(&addr)
        .serve(app.into_make_service())
        .await
        .unwrap();
}
```

- Rocket:
`Managed State`[^3] ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚layer ã¨åŒã˜ãã€Connection Pool ãªã©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãŸã‚‚ã®ã®å—ã‘æ¸¡ã—ã«ä½¿ãˆã¾ã™ã€‚

```rust: main.rs
#[launch]
async fn rocket() -> _ {
    // çœç•¥

    rocket::build()
        .manage(user_service)
        .mount("/", routes![user_handler])
}
```

### Requests and Responses

https://rocket.rs/v0.5/guide/requests/

https://rocket.rs/v0.5/guide/responses/

- Axum:
```rust: routes.rs
pub async fn user_handler(Query(query):Query<UserQuery>, Extension(user_service):Extension<Arc<UserService>>) -> impl IntoResponse {
    match user_service.fetch_user(query.user_id).await {
        Ok(user) => ApiResponse::UserResponse(user),
        Err(_) => ApiResponse::ErrorResponse("Internal Server Error".to_string()),
    }
}
```

- Rocket:
> Dynamic Paths[^4]
You can declare path segments as dynamic by using angle brackets around variable names in a route's path. For example, if we want to say Hello! to anything, not just the world, we can declare a route like so:

```rust: routes.rs
#[get("/users/<user_id>")]
pub async fn user_handler(user_id: i64, user_service: &State<Arc<UserService>>) -> (Status, (ContentType, Json<Option<User>>)) {
    match user_service.fetch_user(user_id).await {
        Ok(user) => (Status::Ok, (ContentType::JSON, Json(user))),
        Err(_) => (Status::InternalServerError, (ContentType::JSON, Json(None))),
    }
}
```

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket

Rust Rocket v0.5 ã«é–¢ã™ã‚‹æ¤œè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ğŸ‘‹

[^1]: https://github.com/tokio-rs/axum
[^2]: https://rocket.rs/
[^3]: https://rocket.rs/v0.5/guide/state/#managed-state
[^4]: https://rocket.rs/v0.5/guide/requests/#dynamic-paths
