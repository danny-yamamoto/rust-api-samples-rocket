---
title: "About Rust Rocket v0.5 and async"
emoji: "ğŸ…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "restapi", "rocket", "axum"]
published: false
---
[Retail AI Adventurers Advent Calendar 2023](https://qiita.com/advent-calendar/2023/rai-adventurers) ã®æŠ•ç¨¿ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€æœ¬æ¥­ï¼ˆSREï¼‰ã®ã‹ãŸã‚ã‚‰ã§å–ã‚Šçµ„ã‚€ Backend Tech Stack ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€ã€ŒRust Rocket[^2] ã¨ async[^6] ã«ã¤ã„ã¦ã€ã§ã™ã€‚

Rocket ãŒ `v0.5`[^5] ã§ async ã«å¯¾å¿œã—ã¾ã—ãŸ â€¼ï¸

> Rocket's core request handling was rebuilt in v0.5 to take advantage of the latest async networking facilities in Rust. Backed by tokio, Rocket automatically multiplexes request handling across async tasks on all of the available cores on the machine. As a result, route handlers can now be declared async and make use of await syntax:
>
> Rocket ã®ã‚³ã‚¢ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã¯ã€Rust ã®æœ€æ–°ã®éåŒæœŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«v0.5ã§å†æ§‹ç¯‰ã•ã‚Œã¾ã—ãŸã€‚tokio ã«ã‚ˆã£ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸ Rocket ã¯ã€ãƒã‚·ãƒ³ä¸Šã§åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®ã‚³ã‚¢ã®éåŒæœŸã‚¿ã‚¹ã‚¯é–“ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã‚’è‡ªå‹•çš„ã«å¤šé‡åŒ–ã—ã¾ã™ã€‚ãã®çµæœã€ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’éåŒæœŸã§å®£è¨€ã—ã€await æ§‹æ–‡ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼š

ã•ã‚‰ã«è©³ã—ãè¦‹ãŸã„æ–¹ã¯èª­ã¿ç¶šã‘ã¦ãã ã•ã„ã€‚

## tl;dr
* Rocket `v0.5`[^5] ãŒ 2023å¹´11æœˆã«  stable ã«ãªã‚Šã¾ã—ãŸã€‚
* async ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
* Rocket ã¯ã€å…¥é–€è€…ã‚„ä¸­è¦æ¨¡å‘ã‘ã§ã™ã€‚

https://rocket.rs/v0.5/news/2023-11-17-version-0.5/

## About Rust Rocket
Rust Rocket[^2] ã¯ã€Rust ã® Web Framework ã® 1 ã¤ã§ã™ã€‚

https://rocket.rs/

Rust ã® Web Framework ã«ã¯ã€ä»–ã«ã‚‚ Axum[^1] ãªã©è¤‡æ•°ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚

:::details Axum ã¨ Rocket ã«é–¢ã™ã‚‹ GPT-4 ã®è§£èª¬
> Rustã§ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹Axumã¨Rocketã«ã¤ã„ã¦ã€ãã‚Œãã‚Œã®é•ã„ã‚’èª¬æ˜ã—ã¾ã™ã€‚
> 1. Axum
>    * é–‹ç™ºå…ƒ: Axumã¯Tokioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚
>    * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: Axumã¯éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ä¸­å¿ƒã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€Tokioã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨æ·±ãçµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šé«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨åŠ¹ç‡ãŒæœŸå¾…ã§ãã¾ã™ã€‚
>    * ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: Axumã§ã¯ã€é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã®å¼·åŠ›ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã§èª­ã¿ã‚„ã™ã„APIè¨­è¨ˆã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
>    * æŸ”è»Ÿæ€§: Axumã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ã¨æ‹¡å¼µæ€§ã«å„ªã‚Œã¦ãŠã‚Šã€ã•ã¾ã–ã¾ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
>    * ä½¿ç”¨ã‚±ãƒ¼ã‚¹: é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‹ã¤æ‹¡å¼µæ€§ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«é©ã—ã¦ã„ã¾ã™ã€‚
> 1. Rocket
>    * é–‹ç™ºå…ƒ: Rocketã¯ç‹¬ç«‹ã—ãŸã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
>    * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: Rocketã¯ã€å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè¨­è¨ˆã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯Rustã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ©ç”¨ã—ã¦ã€å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
>    * ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: Rocketã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã€å±æ€§ãƒ™ãƒ¼ã‚¹ã§ç›´æ„Ÿçš„ã«è¨˜è¿°ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚
>    * ç°¡æ½”æ€§ã¨ç”Ÿç”£æ€§: Rocketã¯ã€å¤šãã®æ©Ÿèƒ½ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ãŠã‚Šã€é–‹ç™ºè€…ãŒç´ æ—©ãåŠ¹ç‡çš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
>    * ä½¿ç”¨ã‚±ãƒ¼ã‚¹: ç‰¹ã«å…¥é–€è€…ã‚„ä¸­è¦æ¨¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©ã—ã¦ãŠã‚Šã€Rustã®å‹å®‰å…¨æ€§ã‚’æ´»ç”¨ã—ãŸé–‹ç™ºã‚’è¡Œã„ãŸã„å ´åˆã«é©ã—ã¦ã„ã¾ã™ã€‚
> * ç·æ‹¬
>    * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ‹¡å¼µæ€§: Axumã¯éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨Tokioã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ·±ã„çµ±åˆã«ã‚ˆã‚Šã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ‹¡å¼µæ€§ã‚’æä¾›ã—ã¾ã™ã€‚
>    * å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•: Rocketã¯ã€Rustã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æœ€å¤§é™ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨æ€§ã¨ä½¿ã„ã‚„ã™ã•ã‚’é‡è¦–ã—ãŸè¨­è¨ˆã§ã™ã€‚
>    * é©ç”¨ç¯„å›²: Axumã¯å¤§è¦æ¨¡ã‹ã¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€Rocketã¯å…¥é–€è€…ã‚„ä¸­è¦æ¨¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é©ã—ã¦ã„ã¾ã™ã€‚
> 
> ã©ã¡ã‚‰ã‚’é¸ã¶ã‹ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã‚„å€‹äººã®å¥½ã¿ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
:::

* Axum: 
å¤§è¦æ¨¡ã‹ã¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚‚ã®å‘ã‘ã€‚
* Rocket: 
å…¥é–€è€…ã‚„ä¸­è¦æ¨¡å‘ã‘ã€‚

è¦ä»¶ã«ã‚ã‚ã›ã¦é¸æŠã—ã¾ã—ã‚‡ã†ã€‚

## Syntax
ãã‚Œã§ã¯å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ä»Šå›å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ database ã‹ã‚‰å–å¾—ã™ã‚‹ REST API ã§ã™ã€‚

```mermaid
flowchart LR
    db[(Database)]
    Client -- /users/1--> App
    App <--> db
    App -- JSON --> Client
```

```rust: routes.rs
#[get("/users/<user_id>")]
pub async fn user_handler(user_id: i64, user_service: &State<Arc<UserService>>) -> (Status, (ContentType, Json<Option<User>>)) {
    match user_service.fetch_user(user_id).await {
        Ok(user) => (Status::Ok, (ContentType::JSON, Json(user))),
        Err(_) => (Status::InternalServerError, (ContentType::JSON, Json(None))),
    }
}
```

```bash: log
vscode âœ /workspaces/rust-api-samples-rocket/rocket (main) $ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.44s
     Running `target/debug/rocket`
ğŸ”§ Configured for debug.
   >> address: 127.0.0.1
   >> port: 8000
   >> workers: 8
   >> max blocking threads: 512
   >> ident: Rocket
   >> IP header: X-Real-IP
   >> limits: bytes = 8KiB, data-form = 2MiB, file = 1MiB, form = 32KiB, json = 1MiB, msgpack = 1MiB, string = 8KiB
   >> temp dir: /tmp
   >> http/2: true
   >> keep-alive: 5s
   >> tls: disabled
   >> shutdown: ctrlc = true, force = true, signals = [SIGTERM], grace = 2s, mercy = 3s
   >> log level: normal
   >> cli colors: true
   >> secret key: [generated]
Warning: secrets enabled without a stable `secret_key`
   >> disable `secrets` feature or configure a `secret_key`
   >> this becomes an error in non-debug profiles
ğŸ“¬ Routes:
   >> (user_handler) GET /users/<user_id>
ğŸ“¡ Fairings:
   >> Shield (liftoff, response, singleton)
ğŸ›¡ï¸ Shield:
   >> X-Content-Type-Options: nosniff
   >> X-Frame-Options: SAMEORIGIN
   >> Permissions-Policy: interest-cohort=()
ğŸš€ Rocket has launched from http://127.0.0.1:8000
```

### ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã®æ–¹æ³•
Connection Pool ãªã©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãŸã‚‚ã®ã®å—ã‘æ¸¡ã—ã«ã¤ã„ã¦ã§ã™ã€‚

- Axum:
`layer` method ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```rust: main.rs
#[tokio::main]
async fn main() {
    dotenv().ok();
    let key = "DATABASE_URL".to_string();
    let database_url = env::var(key).expect("Failed to set environment variables");
    let pool = SqlitePool::connect(&database_url)
        .await
        .expect("Failed to connect database.");
    let user_service = Arc::new(UserService::new(pool));
    let app = Router::new().route("/users/:user_id", get(user_handler))
        .layer(Extension(user_service));    // ğŸ‘ˆ Here
    let listener = tokio::net::TcpListener::bind("0.0.0.0:8000")
        .await.unwrap();
    axum::serve(listener, app).await.unwrap();
}
```

- Rocket:
`manage`[^3] method ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://rocket.rs/v0.5/guide/state/#managed-state

```rust: main.rs
#[launch]
async fn rocket() -> _ {
    dotenv().ok();
    let key = "DATABASE_URL".to_string();
    let db_url = env::var(key).expect("Failed to set environment variables.");
    let pool = SqlitePool::connect(&db_url).await.expect("Failed to connect database.");
    let user_service = Arc::new(UserService::new(pool));
    rocket::build()
        .manage(user_service)    // ğŸ‘ˆ Here
        .mount("/", routes![user_handler])
}
```

### Requests and Responses
- Axum:
path ã‚’ main ã® router ã§å®šç¾©ã—ã¾ã™ã€‚

https://docs.rs/axum/latest/axum/extract/struct.MatchedPath.html

```rust: main.rs
    let app = Router::new().route("/users/:user_id", get(user_handler))    // ğŸ‘ˆ Here
        .layer(Extension(user_service));
```

```rust: routes.rs
pub async fn user_handler(Path(user_id): Path<i64>, Extension(user_service): Extension<Arc<UserService>>) -> (StatusCode, Json<Option<User>>) {
    match user_service.fetch_user(user_id).await {
        Ok(user) => (StatusCode::OK, Json(user)),
        Err(_) => (StatusCode::INTERNAL_SERVER_ERROR, Json(None)),
    }
}
```

- Rocket:
path ã‚’ handler å´ã§å®šç¾©ã—ã¾ã™ã€‚
> **Dynamic Paths**[^4]
You can declare path segments as dynamic by using angle brackets around variable names in a route's path. For example, if we want to say Hello! to anything, not just the world, we can declare a route like so:

```rust: routes.rs
#[get("/users/<user_id>")]    // ğŸ‘ˆ Here
pub async fn user_handler(user_id: i64, user_service: &State<Arc<UserService>>) -> (Status, (ContentType, Json<Option<User>>)) {
    match user_service.fetch_user(user_id).await {
        Ok(user) => (Status::Ok, (ContentType::JSON, Json(user))),
        Err(_) => (Status::InternalServerError, (ContentType::JSON, Json(None))),
    }
}
```

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket

Rust Rocket `v0.5` ã«é–¢ã™ã‚‹æ¤œè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ğŸ‘‹

[^1]: https://github.com/tokio-rs/axum
[^2]: https://rocket.rs/
[^3]: https://rocket.rs/v0.5/guide/state/#managed-state
[^4]: https://rocket.rs/v0.5/guide/requests/#dynamic-paths
[^5]: https://rocket.rs/v0.5/news/2023-11-17-version-0.5/
[^6]: ã‚ã‚‹ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ãŸãšã«ã€ä»–ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®æ‰‹æ³•ã§ã™ã€‚ä¾‹ãˆã°ã€Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹éš›ã€åŒæœŸçš„ãªå‡¦ç†ã ã¨ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚‹ã¾ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå›ºã¾ã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€éåŒæœŸå‡¦ç†ã‚’ä½¿ã†ã“ã¨ã§ã€ãã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹é–“ã‚‚ä»–ã®æ“ä½œãŒå¯èƒ½ã«ãªã‚Šã€ã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã‚’æä¾›ã§ãã¾ã™ã€‚
