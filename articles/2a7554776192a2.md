---
title: "About Rust Rocket v0.5 and async"
emoji: "🎅"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
[Retail AI Adventurers Advent Calendar 2023](https://qiita.com/advent-calendar/2023/rai-adventurers) の投稿です。

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) は、[トライアルカンパニー](https://www.trial-net.co.jp) を軸とした小売におけるお客様の買い物体験の向上を目指す企業です。

この投稿では、本業（SRE）のかたわらで取り組む Backend Tech Stack について書きます。

題材は、「Rust Rocket と Async について」です。

![image](image-1.png)

## tl;dr
* Rocket `v0.5`[^2] が 2023年11月に  stable になりました。
* Async が `v0.5` で追加されました。
* Rocket は、入門者や中規模向けです。

https://rocket.rs/v0.5/news/2023-11-17-version-0.5/

さらに詳しく見たい方は読み続けてください。

## About Rust Rocket
Rust Rocket[^2] は、Rust の Web Framework の 1 つです。

https://rocket.rs/

Rust の Web Framework には、他にも Axum[^1] など複数の選択肢があります。

:::details Axum と Rocket に関する GPT-4 の解説
> RustでのWebフレームワークであるAxumとRocketについて、それぞれの違いを説明します。
> 1. Axum
>    * 開発元: AxumはTokioプロジェクトによって開発されています。
>    * アーキテクチャ: Axumは非同期プログラミングを中心に設計されており、Tokioエコシステムと深く統合されています。これにより高いパフォーマンスと効率が期待できます。
>    * ルーティング: Axumでは、関数型プログラミングスタイルの強力なルーティング機能があります。これは、シンプルで読みやすいAPI設計を可能にします。
>    * 柔軟性: Axumはカスタマイズ性と拡張性に優れており、さまざまなミドルウェアやプラグインを組み込むことができます。
>    * 使用ケース: 高パフォーマンスかつ拡張性の高いアプリケーション開発に適しています。
> 1. Rocket
>    * 開発元: Rocketは独立したコミュニティベースのプロジェクトです。
>    * アーキテクチャ: Rocketは、安全性と使いやすさに焦点を当てた設計です。これにより、開発者はRustの型システムを利用して、安全かつ効率的なWebアプリケーションを構築できます。
>    * ルーティング: Rocketのルーティングは、属性ベースで直感的に記述できます。これにより、コードの可読性と保守性が向上します。
>    * 簡潔性と生産性: Rocketは、多くの機能が組み込まれており、開発者が素早く効率的にアプリケーションを構築できるように設計されています。
>    * 使用ケース: 特に入門者や中規模のプロジェクトに適しており、Rustの型安全性を活用した開発を行いたい場合に適しています。
> * 総括
>    * パフォーマンスと拡張性: Axumは非同期プログラミングとTokioエコシステムへの深い統合により、高いパフォーマンスと拡張性を提供します。
>    * 安全性と使いやすさ: Rocketは、Rustの型システムを最大限に利用することで、安全性と使いやすさを重視した設計です。
>    * 適用範囲: Axumは大規模かつパフォーマンスが求められるアプリケーション、Rocketは入門者や中規模アプリケーションに適しています。
> 
> どちらを選ぶかは、プロジェクトの要件や個人の好みによって異なります。
:::

* Axum: 
大規模かつパフォーマンスが求められるもの向け。
* Rocket: 
入門者や中規模向け。

## Implementation
それでは実装を見ていきます。

今回実装しているのは、`users` という table からデータを取得する REST API です。

### データ共有の方法
- Axum:
resource を `layer` メソッドを使用して渡すことができます。Connection Pool などインスタンス化したものの受け渡しに使えます。

```rust: main.rs
#[tokio::main]
async fn main() {
    // 省略
    
    let app = Router::new()
        .route("/users", get(user_handler).layer(Extension(user_service)))
    let addr = SocketAddr::new(IpAddr::V4(Ipv4Addr::new(127, 0, 0, 1)), 8080);
    axum::Server::bind(&addr)
        .serve(app.into_make_service())
        .await
        .unwrap();
}
```

- Rocket:
`Managed State`[^3] を使用します。layer と同じく、Connection Pool などインスタンス化したものの受け渡しに使えます。

```rust: main.rs
#[launch]
async fn rocket() -> _ {
    // 省略

    rocket::build()
        .manage(user_service)
        .mount("/", routes![user_handler])
}
```

### Requests and Responses

https://rocket.rs/v0.5/guide/requests/

https://rocket.rs/v0.5/guide/responses/

- Axum:
```rust: routes.rs
pub async fn user_handler(Query(query):Query<UserQuery>, Extension(user_service):Extension<Arc<UserService>>) -> impl IntoResponse {
    match user_service.fetch_user(query.user_id).await {
        Ok(user) => ApiResponse::UserResponse(user),
        Err(_) => ApiResponse::ErrorResponse("Internal Server Error".to_string()),
    }
}
```

- Rocket:
> Dynamic Paths[^4]
You can declare path segments as dynamic by using angle brackets around variable names in a route's path. For example, if we want to say Hello! to anything, not just the world, we can declare a route like so:

```rust: routes.rs
#[get("/users/<user_id>")]
pub async fn user_handler(user_id: i64, user_service: &State<Arc<UserService>>) -> (Status, (ContentType, Json<Option<User>>)) {
    match user_service.fetch_user(user_id).await {
        Ok(user) => (Status::Ok, (ContentType::JSON, Json(user))),
        Err(_) => (Status::InternalServerError, (ContentType::JSON, Json(None))),
    }
}
```

今回のコードはこちら。

https://github.com/danny-yamamoto/rust-api-samples-rocket

Rust Rocket v0.5 に関する検証は以上です。

この投稿をみて何か得られた方は、いいね ❤️ をお願いします。

それでは、次回のアドカレでお会いしましょう。👋

[^1]: https://github.com/tokio-rs/axum
[^2]: https://rocket.rs/
[^3]: https://rocket.rs/v0.5/guide/state/#managed-state
[^4]: https://rocket.rs/v0.5/guide/requests/#dynamic-paths
